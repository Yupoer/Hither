# 數據流模式

## 1. 驗證流程

```
用戶 → AuthenticationService → Firebase Auth → HitherUser
```

**流程：**
1. 用戶使用 Google/Apple ID/電子郵件登錄
2. AuthenticationService 處理 Firebase Auth
3. 創建/更新 HitherUser 對象
4. 在 AuthenticationService 中存儲當前用戶

**數據模型：**
```swift
struct HitherUser {
    let id: String
    let email: String
    let displayName: String
    let photoURL: String?
}
```

## 2. 群組創建流程 🆕 **v2.1 更新**

```
用戶輸入 → GroupService → Firebase Firestore (群組 + 成員子集合) → 實時監聽器
```

**流程：**
1. 用戶在 GroupSetupView 中輸入群組名稱
2. 調用 GroupService.createGroup() 並帶有領導者資訊
3. 創建群組文件寫入 `/groups/{groupId}` 集合
4. 同時創建領導者文件寫入 `/groups/{groupId}/members/{leaderId}` 子集合
5. 啟動群組和成員子集合的實時監聽器
6. 更新本地 currentGroup 狀態

## 3. 群組加入流程 🆕 **v2.1 更新**

```
邀請碼 → GroupService → Firebase 查詢 → 成員子集合添加 → 實時同步
```

**流程：**
1. 用戶輸入邀請碼或掃描 QR 碼
2. GroupService.joinGroup() 查詢 Firebase 匹配邀請碼
3. 驗證邀請碼過期時間和用戶資格
4. 在 `/groups/{groupId}/members/{userId}` 子集合中創建新成員文件
5. 成員子集合監聽器將新成員同步到所有群組成員
6. 更新本地群組成員列表

## 4. 實時同步 🆕 **v2.1 更新**

```
Firebase 更改 → Firestore 監聽器 (群組 + 成員子集合) → GroupService → SwiftUI 狀態更新
```

**實現：**
- 使用 Firestore `addSnapshotListener` 同時監聽群組文件和成員子集合
- GroupService 維護群組和成員的雙重監聽器
- 成員位置更新只觸發子集合監聽器，提升效率
- SwiftUI 視圖對 `@Published` 屬性更改做出反應

**關鍵方法：**
- `startListeningToGroup(groupId:)` - 啟動群組文件監聽器
- `startListeningToMembers(groupId:)` - 啟動成員子集合監聽器
- `parseMemberFromData(_:)` - 解析成員子集合數據
- `validateAndRepairGroupData(_:)` - 驗證和修復損壞的數據

## 5. 位置更新 🆕 **v2.1 更新**

```
CoreLocation → 位置服務 → Firebase 成員子集合更新 → 實時同步
```

**流程：**
1. CoreLocation 提供 GPS 坐標
2. 位置更新直接寫入 `/groups/{groupId}/members/{userId}` 文件
3. 只更新 `location` 和 `lastLocationUpdate` 字段
4. 成員子集合監聽器將位置更新推送給其他群組成員
5. 更高效的更新機制：只同步變更的成員，而非整個成員陣列

## 6. 推送通知

```
FCM 令牌 → Firebase Functions → 推送通知 → 用戶設備
```

**整合：**
- Firebase Cloud Messaging (FCM) 處理推送通知
- 用於群組命令、航點更新和成員警报
- 不同操作類型的通知類別
